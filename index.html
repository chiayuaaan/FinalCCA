<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XYZ Sentinel: CEO COMMAND</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<!-- Add this AFTER three.min.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js/dist/face-api.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<style>
/* --- CORE STYLES --- */
:root {
    --bg-color: #020202;
    --panel-bg: #0f0f0f;
    --border: rgba(255, 255, 255, 0.12);
    --primary: #0A84FF;
    --success: #30D158;
    --warning: #FF9F0A;
    --danger: #FF453A;
    --text-main: #Eaeaea;
    --text-muted: #86868b;
    --font: "SF Mono", "Consolas", monospace;
}

body {
    margin: 0; background: var(--bg-color); color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    overflow: hidden; /* KEEP THIS: prevents whole page scroll */
    display: flex; height: 100vh; /* KEEP THIS: fixes total height */
}

/* --- UTILS --- */
.input_video { display: none; } 
#debug-canvas {
    position: fixed; bottom: 20px; right: 20px; width: 160px; height: 120px;
    border: 2px solid var(--success); border-radius: 12px; z-index: 20002;
    opacity: 0; pointer-events: none; background: rgba(0,0,0,0.5); transition: opacity 0.5s;
}

.btn {
    background: var(--text-main); color: black; border: none; padding: 8px 16px;
    border-radius: 6px; font-weight: 700; cursor: pointer; text-transform: uppercase;
    font-size: 11px; letter-spacing: 1px; transition: 0.2s; font-family: var(--font);
}
.btn:hover { transform: scale(1.05); background: var(--primary); color: white; }
.btn-danger { background: rgba(255, 69, 58, 0.2); color: var(--danger); border: 1px solid var(--danger); }
.btn-danger:hover { background: var(--danger); color: black; }

/* --- SIDEBAR --- */
.sidebar {
    width: 60px; background: #050505; border-right: 1px solid var(--border);
    display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 10;
}
.nav-item {
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center;
    justify-content: center; color: var(--text-muted); cursor: pointer; margin-bottom: 20px;
    transition: 0.2s;
}
.nav-item:hover, .nav-item.active { background: #222; color: var(--primary); }
.settings-btn { margin-top: auto; border: 1px solid var(--border); }

/* ... (around line 73) */
.main-content { 
    flex: 1; position: relative; 
    overflow-x: hidden;
    /* The main-content is already sized by body/flex, no change needed here */
}
/* --- FIX 1: ENABLE SCROLLING ON DASHBOARD --- */
.view-section {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; /* Default for AI/Earth fixed views */
    display: none; padding: 30px; box-sizing: border-box; 
    opacity: 0; transition: opacity 0.3s; overflow-y: auto
}
.view-section.active { display: flex; opacity: 1; }

.card {
    background: var(--panel-bg); border: 1px solid var(--border);
    border-radius: 16px; padding: 20px;
}

/* --- DASHBOARD --- */
/* FIX: Override general view-section for the dashboard to allow scrolling */
/* FIX: Definitive fix for VERTICAL BOUNCE (Jitter) */
#view-dashboard {
    position: relative; 
    width: 100%; 
    height: 100%;
    overflow-y: auto; 
    overflow-x: hidden;
    
    /* CRITICAL FIX for Flexbox Jitter: */
    display: flex; /* Kept display:flex here from previous active state logic */
    flex-direction: column;
    min-height: 0; /* Ensures the browser calculates heights correctly */
    
    gap: 20px;
}
#view-dashboard.active { 
    display: flex; 
    opacity: 1; 
}
/* Ensure AI view also uses 100% height for its split container */
#view-ai {
    height: 100%;
}
.metric-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }

/* DEPARTMENT MATRIX STYLE */
.dept-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-top: 20px; }
.dept-card {
    background: #111; border: 1px solid var(--border); border-radius: 12px; padding: 15px;
    display: flex; flex-direction: column; gap: 10px; transition: 0.2s; position: relative; overflow: hidden;
}
.dept-card.alert { border-color: var(--danger); box-shadow: 0 0 15px rgba(255, 69, 58, 0.2); }
.dept-icon { font-size: 24px; color: var(--text-muted); }
.dept-name { font-size: 11px; font-weight: 700; color: var(--text-main); letter-spacing: 0.5px; }
.dept-status { font-size: 10px; color: var(--success); font-family: var(--font); }
.dept-card.alert .dept-status { color: var(--danger); }
.dept-action { margin-top: auto; width: 100%; font-size: 10px; padding: 5px; }

/* --- AI / INTELLIGENCE (SPLIT SCREEN) --- */
#view-ai { padding: 0; }
.ai-split-container { display: flex; width: 100%; height: 100%; }

/* LEFT PANEL: COMMAND DECK */
.ai-left-panel {
    width: 45%; background: #080808; border-right: 1px solid var(--border);
    display: flex; flex-direction: column; padding: 25px; box-sizing: border-box; overflow-y: auto;
}

.upload-header {
    display: flex; justify-content: space-between; align-items: center; 
    padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 20px;
}
.upload-zone {
    border: 1px dashed var(--border); border-radius: 8px; padding: 20px;
    text-align: center; cursor: pointer; transition: 0.2s; margin-bottom: 20px;
    background: rgba(255,255,255,0.02);
}
.upload-zone:hover { border-color: var(--primary); background: rgba(10,132,255,0.05); }

.viz-feed { display: flex; flex-direction: column; gap: 25px; padding-bottom: 50px; }

/* WIDGET STYLING */
.viz-widget {
    background: #111; border: 1px solid var(--border);
    border-radius: 12px; padding: 20px; position: relative;
    animation: slideDown 0.4s ease-out;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
@keyframes slideDown { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }

.viz-header { 
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; 
    border-bottom: 1px solid #222; padding-bottom: 10px;
}
.viz-title { font-size: 12px; font-weight: 800; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; font-family: var(--font); }
.viz-meta { font-size: 10px; color: var(--text-muted); }
.viz-delete { cursor: pointer; color: #555; transition: 0.2s; }
.viz-delete:hover { color: var(--danger); }

/* Bar Chart Styles */
.bar-row { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
.bar-label { width: 140px; font-size: 11px; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: var(--font); }
.bar-track { flex: 1; height: 8px; background: #222; border-radius: 4px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 4px; width: 0%; transition: width 1s cubic-bezier(0.2, 0.8, 0.2, 1); }
.bar-val { width: 50px; text-align: right; font-family: var(--font); font-size: 11px; font-weight: bold; color: var(--primary); }

/* RIGHT PANEL: CHAT */
.ai-right-panel { flex: 1; display: flex; flex-direction: column; background: #000; }
.chat-header { padding: 15px 25px; border-bottom: 1px solid var(--border); background: #050505; display: flex; justify-content: space-between; align-items: center; }
.chat-history { 
    flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; 
}
.chat-input-area { padding: 20px; border-top: 1px solid var(--border); background: #050505; display: flex; gap: 10px; }

.msg { max-width: 90%; font-size: 14px; line-height: 1.6; }
.msg.ai { align-self: flex-start; color: #dcdcdc; }
.msg.user { 
    background: #1a1a1a; padding: 12px 18px; 
    border-radius: 12px; border: 1px solid #333; color: white; 
}
.msg table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 12px; }
.msg th { text-align: left; border-bottom: 1px solid #444; padding: 8px; color: var(--text-muted); text-transform: uppercase; }
.msg td { border-bottom: 1px solid #222; padding: 8px; color: var(--text-main); }
.msg strong { color: white; font-weight: 700; }

/* --- EARTH HOLOGRAM --- */
#earth-wrapper {
    width: 100%; height: 100%; border-radius: 24px; overflow: hidden; position: relative;
    border: 1px solid var(--border); transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}
#earth-wrapper.fullscreen {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    border-radius: 0; z-index: 9999; border: none; background: #000;
}
#earth-container { width: 100%; height: 100%; }

.hud-overlay {
    position: absolute; pointer-events: none; width: 100%; height: 100%; top:0; left:0;
    padding: 40px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between;
    opacity: 0; transition: opacity 0.5s;
}
.fullscreen .hud-overlay { opacity: 1; }

.hud-scanner {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 300px; height: 300px; border: 1px solid rgba(255,255,255,0.1);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
}
.hud-scanner::before {
    content: ''; position: absolute; top: -10px; bottom: -10px; width: 2px; background: var(--success);
    box-shadow: 0 0 15px var(--success); opacity: 0.5; animation: rotateScan 2s linear infinite;
}
@keyframes rotateScan { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* CEO-Grade Popup */
.scan-result {
    background: rgba(0,0,0,0.8); border: 1px solid var(--primary); color: white;
    padding: 20px 40px; border-radius: 12px; font-family: var(--font); text-align: center;
    opacity: 0; transform: translateY(20px); transition: 0.3s;
    box-shadow: 0 0 30px rgba(10,132,255,0.2);
}

.btn-close {
    position: absolute; top: 30px; right: 30px; background: rgba(255,255,255,0.2);
    color: white; width: 40px; height: 40px; border-radius: 50%; display: none;
    align-items: center; justify-content: center; cursor: pointer; z-index: 10001;
}
.fullscreen .btn-close { display: flex; }

/* Modal */
.modal-overlay {
    position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9);
    z-index: 20000; display:none; justify-content:center; align-items:center;
}
/* ================= FACE LOCK CSS (from onlyFace.html) ================= */
#lock-screen {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: black;
    z-index: 999999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: transform 0.8s ease;
}

#lock-video-container {
    width: 260px; height: 260px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid #333;
    position: relative;
    margin-bottom: 20px;
}

#lock-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
}

#lock-scan-line {
    position: absolute;
    top: 0;
    left: 0;
    height: 4px;
    width: 100%;
    background: #0A84FF;
    animation: scan 1.5s infinite alternate;
}

@keyframes scan {
    from { top: 0%; }
    to { top: 100%; }
}

.lock-title {
    font-size: 22px;
    font-family: "SF Mono", monospace;
    font-weight: 800;
    margin-bottom: 8px;
}

.lock-status {
    font-size: 12px;
    color: #888;
}

#admin-setup {
    display: none;
    margin-top: 20px;
    text-align: center;
}

#passcode-input {
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #444;
    background: #111;
    color: white;
    text-align: center;
}

.btn {
    background: #0A84FF;
    color: white;
    border: none;
    padding: 8px 16px;
    margin-top: 10px;
    border-radius: 6px;
    cursor: pointer;
}

.hidden { display: none !important; }

#setup-toggle {
    position: absolute;
    top: 20px;
    right: 20px;
    color: #444;
    cursor: pointer;
}
/* TACTICAL MAP STYLES */
#map-container { width: 100%; height: 100%; z-index: 1; background: #000; }

/* This filter turns a normal white map into a dark sci-fi blueprint */
.leaflet-layer { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
/* Invert labels back so they are readable, or leave them for abstract look. 
   Here we keep them dark for the aesthetic. */

.map-hud-panel {
    position: absolute; top: 30px; right: 30px; 
    background: rgba(0,0,0,0.85); border: 1px solid #333;
    padding: 20px; border-radius: 12px; z-index: 999;
    backdrop-filter: blur(5px); width: 250px;
}
.layer-toggle {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 0; border-bottom: 1px solid #222; cursor: pointer;
}
.layer-toggle:last-child { border-bottom: none; }
.toggle-label { font-size: 12px; font-weight: 700; color: #ccc; letter-spacing: 1px; }
.toggle-switch {
    width: 36px; height: 20px; background: #333; border-radius: 20px;
    position: relative; transition: 0.3s;
}
.toggle-switch::after {
    content:''; position: absolute; top: 2px; left: 2px;
    width: 16px; height: 16px; background: #555; border-radius: 50%;
    transition: 0.3s;
}
.layer-toggle.active .toggle-switch { background: var(--primary); }
.layer-toggle.active .toggle-switch::after { transform: translateX(16px); background: white; }

/* Custom Map Markers */
.blip {
    width: 12px; height: 12px; background: var(--primary);
    border-radius: 50%; box-shadow: 0 0 10px var(--primary);
    animation: pulse 2s infinite;
    z-index: 1000; /* CRITICAL: Ensure it sits above map tiles */
}
.blip.danger { background: var(--danger); box-shadow: 0 0 15px var(--danger); }
.blip.secure { background: var(--success); box-shadow: 0 0 1px var(--success); }

.custom-div-icon {
    z-index: 999 !important; 
}

@keyframes pulse { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(3); } }

/* Animated Traffic Lines */
.traffic-line-anim {
    stroke-dasharray: 10, 10; /* Creates dashes */
    animation: dash 1s linear infinite; /* Moves them */
}

@keyframes dash {
    to { stroke-dashoffset: -20; }
}

/* 2. HOLOGRAPHIC POPUPS (Override default white bubbles) */
.leaflet-popup-content-wrapper, .leaflet-popup-tip {
    background: rgba(0, 0, 0, 0.9) !important; /* Dark background */
    border: 1px solid var(--primary) !important; /* Blue neon border */
    color: var(--text-main) !important;
    border-radius: 4px !important;
    box-shadow: 0 0 15px rgba(10, 132, 255, 0.3) !important;
}
.leaflet-popup-content {
    font-family: var(--font);
    font-size: 11px;
    margin: 10px;
}

/* FORCE FULL SCREEN FOR MAP ONLY */
#view-map {
    padding: 0 !important; /* Removes the 30px gap */
}

/* Optional: If you want to remove the 'card' look completely */
#view-map > div {
    border-radius: 0 !important;
    border: none !important;
}

/* --- SENSOR GRID STYLES --- */
.sensor-card {
    background: linear-gradient(180deg, #111 0%, #0a0a0a 100%);
    border: 1px solid #333;
    border-radius: 12px;
    padding: 15px;
    position: relative;
    overflow: hidden;
}
.sensor-card::after {
    content: ''; position: absolute; top:0; left:0; width:100%; height:2px;
    background: var(--primary);
    box-shadow: 0 0 10px var(--primary);
    opacity: 0.5;
}
.sensor-header {
    display: flex; align-items: center; gap: 8px;
    font-size: 10px; font-weight: 700; color: var(--text-muted);
    letter-spacing: 1px; margin-bottom: 10px;
}
.sensor-value {
    font-size: 24px; font-weight: 700; color: white;
    font-family: var(--font);
}
.sensor-sub {
    font-size: 10px; color: #666; margin-top: 5px; font-family: var(--font);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.live-indicator {
    font-size: 10px; color: var(--success); font-weight: bold;
    border: 1px solid rgba(48, 209, 88, 0.3); padding: 2px 6px; border-radius: 4px;
}
.blink { animation: blinker 1s linear infinite; }
@keyframes blinker { 50% { opacity: 0; } }

</style>
</head>

<body>
<!-- ================= FACE LOCK MODULE (from onlyFace.html) ================= -->
<div id="lock-screen">
    <div id="setup-toggle" onclick="toggleSetup()">
        <i data-lucide="settings" size="16"></i>
    </div>

    <div id="lock-video-container">
        <video id="lock-video" autoplay muted playsinline></video>
        <div id="lock-scan-line"></div>
    </div>

    <div class="lock-title">XYZ SENTINEL</div>
    <div class="lock-status" id="lock-status">INITIALIZING BIOMETRICS...</div>

    <div id="admin-setup">
        <input type="password" id="passcode-input" placeholder="Enter Passcode">
        <br>
        <button class="btn" onclick="verifyPasscode()">UNLOCK / SETUP</button>
        <br><br>
        <button id="enroll-btn" class="btn hidden" onclick="enrollFace()">CAPTURE FACE ID</button>
    </div>
</div>

<div class="modal-overlay" id="api-modal">
    <div style="width:300px; background:#111; padding:30px; border-radius:12px; border:1px solid #333;">
        <h3>SYSTEM ACCESS</h3>
        <p style="font-size:12px; color:#888;">Enter OpenAI Key to activate Neural Core.</p>
        <input type="password" id="api-input" placeholder="sk-..." style="width:100%; padding:10px; background:#222; border:1px solid #444; color:white; margin-bottom:10px;">
        <button class="btn" onclick="saveKey()">Connect</button>
        <button class="btn" style="background:transparent; border:1px solid #555; color:#888;" onclick="document.getElementById('api-modal').style.display='none'">Close</button>
    </div>
</div>

<video class="input_video" playsinline></video>
<canvas id="debug-canvas" width="320" height="240"></canvas>

<nav class="sidebar">
    <div class="nav-item active" id="nav-dashboard" onclick="switchView('dashboard')"><i data-lucide="layout-grid"></i></div>
    <div class="nav-item" id="nav-ai" onclick="switchView('ai')"><i data-lucide="bot"></i></div>
    <div class="nav-item" id="nav-earth" onclick="enterFullscreenEarth()"><i data-lucide="globe"></i></div>
    <div class="nav-item" id="nav-map" onclick="switchView('map')"><i data-lucide="map"></i></div>
    <div style="flex:1"></div>
    <div class="nav-item settings-btn" onclick="document.getElementById('api-modal').style.display='flex'"><i data-lucide="settings"></i></div>
</nav>

<main class="main-content">

    <section id="view-dashboard" class="view-section active">
    <h1>COMMAND DECK</h1>
    
    <div class="metric-grid" style="grid-template-columns: repeat(2, 1fr);">
        <div class="card">
            <div style="color:var(--text-muted); font-size:12px;">GLOBAL THREAT</div>
            <div style="font-size:32px; font-weight:700; color:var(--danger)">CRITICAL</div>
        </div>
        <div class="card">
            <div style="color:var(--text-muted); font-size:12px;">SYSTEM INTEGRITY</div>
            <div style="font-size:32px; font-weight:700; color:var(--success)">98.4%</div>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
        
        <div class="card" style="display:flex; align-items:center; justify-content:space-between;">
            <div>
                <div style="color:var(--text-muted); font-size:12px;">HOLOGRAM</div>
                <div style="font-size:18px; font-weight:700;">HAND TRACKING</div>
            </div>
            <button class="btn" onclick="enterFullscreenEarth()">INITIALIZE</button>
        </div>
        
        <div class="card" style="cursor: pointer; border: 1px solid var(--primary); background: rgba(10, 132, 255, 0.1); display:flex; align-items:center; justify-content:space-between;" onclick="initLiveEarth()">
            <div>
                <div style="color:var(--primary); font-size:12px; font-weight:bold;">LIVE MAP</div>
                <div style="font-size:18px; font-weight:700;">ACTIVATE SENSOR</div>
            </div>
            <i data-lucide="mouse-pointer" style="color: var(--primary);"></i>
        </div>
        
    </div>
<h3 style="margin-top:30px; font-size:14px; color:var(--text-muted); display:flex; justify-content:space-between; align-items:center;">
            GLOBAL THREAT INTELLIGENCE (LIVE)
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn" style="padding:4px 10px; font-size:10px; border:1px solid var(--primary);" onclick="generateLiveReport()">
                    <i data-lucide="brain-circuit" size="10"></i> AI ANALYSIS
                </button>
                <span class="live-indicator"><span class="blink">●</span> LIVE</span>
            </div>
        </h3>

        <div class="sensor-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:10px;">
            
            <div class="sensor-card">
                <div class="sensor-header">
                    <i data-lucide="shield-alert" size="16"></i>
                    <span>LATEST VULNERABILITY (CVE)</span>
                </div>
                <div class="sensor-value" id="api-cve" style="font-size:16px;">SCANNING...</div>
                <div class="sensor-sub" id="api-cve-desc">Connecting to National DB...</div>
            </div>

            <div class="sensor-card">
                <div class="sensor-header">
                    <i data-lucide="radio" size="16"></i>
                    <span>GLOBAL INTEL FEED</span>
                </div>
                <div class="sensor-value" id="api-news" style="font-size:13px; line-height:1.4;">INITIALIZING FEED...</div>
                <div class="sensor-sub" id="api-news-src">SOURCE: HACKER_NEWS_API</div>
            </div>

            <div class="sensor-card">
                <div class="sensor-header">
                    <i data-lucide="activity" size="16"></i>
                    <span>INTERNAL NET_FLOW</span>
                </div>
                <canvas id="network-canvas" style="width:100%; height:40px; margin-top:10px;"></canvas>
                <div class="sensor-sub" style="color:var(--primary); margin-top:5px;">PACKETS: <span id="net-packets">0</span>/s</div>
            </div>

        </div>

        <h3 style="margin-top:30px; font-size:14px; color:var(--text-muted);">DEPARTMENTAL READINESS</h3>
    <div class="dept-grid">
        <div class="dept-card" id="dept-computer">
            <i data-lucide="cpu" class="dept-icon"></i>
            <div class="dept-name">COMPUTER (IT)</div>
            <div class="dept-status">SECURE</div>
            <button class="btn dept-action" onclick="sendCommand('Computer', 'Run Diagnostic')">DIAGNOSTIC</button>
        </div>
        <div class="dept-card" id="dept-cyber">
            <i data-lucide="shield-check" class="dept-icon"></i>
            <div class="dept-name">CYBERSECURITY</div>
            <div class="dept-status">MONITORING</div>
            <button class="btn dept-action btn-danger" onclick="sendCommand('Cybersecurity', 'Increase Firewall Level')">ELEVATE DEFCON</button>
        </div>
        <div class="dept-card" id="dept-finance">
            <i data-lucide="badge-dollar-sign" class="dept-icon"></i>
            <div class="dept-name">FINANCE</div>
            <div class="dept-status">SECURE</div>
            <button class="btn dept-action" onclick="sendCommand('Finance', 'Freeze External Transfers')">LOCK TRANSFERS</button>
        </div>
        <div class="dept-card" id="dept-services">
            <i data-lucide="server" class="dept-icon"></i>
            <div class="dept-name">SERVICES</div>
            <div class="dept-status">OPTIMAL</div>
            <button class="btn dept-action" onclick="sendCommand('Services', 'Rotate API Keys')">ROTATE KEYS</button>
        </div>
        <div class="dept-card" id="dept-marketing">
            <i data-lucide="megaphone" class="dept-icon"></i>
            <div class="dept-name">MARKETING</div>
            <div class="dept-status">SECURE</div>
            <button class="btn dept-action" onclick="sendCommand('Marketing', 'Social Media Lockdown')">LOCK SOCIALS</button>
        </div>
    </div>
    <div class="card" style="margin-top: 20px; height: 700px; width:100%; display: flex; padding: 0; ">
    <div style="padding: 15px; border-bottom: 1px solid var(--border); background: #111; display: flex; justify-content: space-between;">
        <span style="font-size: 12px; font-weight: 700; color: var(--text-muted);">LIVE TRAFFIC FEED (WIKIPEDIA STREAM PROXY)</span>
        <span style="font-size: 10px; color: var(--success);">ENCRYPTED</span>
    </div>
    <div style="flex: 1; overflow-y: auto;">
        <table style="width: 100%; border-collapse: collapse; font-family: monospace; font-size: 11px;">
            <thead style="background: #080808; color: #555; text-align: left;">
                <tr>
                    <th style="padding: 10px;">TIME</th>
                    <th style="padding: 10px;">ORIGIN</th>
                    <th style="padding: 10px;">TARGET</th>
                    <th style="padding: 10px;">TYPE</th>
                    <th style="padding: 10px; text-align: right;">RISK</th>
                </tr>
            </thead>
            <tbody id="live-feed-body">
                </tbody>
        </table>
    </div>
</div>

<div class="card" style="margin-top: 20px; padding: 20px; height: 350px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div style="font-size:14px; font-weight:700; color:var(--text-main);">
            NETWORK THROUGHPUT (PACKETS/SEC)
        </div>
        
        <div style="font-size: 24px; font-weight: 800; font-family: var(--font); color: var(--primary);" id="live-throughput-value">
            0.0
        </div>
    </div>

    <div style="margin-bottom: 15px; font-size: 11px; font-family: var(--font);">
        <span id="throughput-status-indicator" style="color: var(--success);">
            Status: OPTIMAL FLOW
        </span>
    </div>

    <div style="height: 250px;">
        <canvas id="realtimeChart"></canvas>
    </div>
</div>


</section>

    <section id="view-ai" class="view-section">
        <div class="ai-split-container">
            
            <div class="ai-left-panel">
                <div class="upload-header">
                    <div>
                        <h2 style="margin:0; color:var(--text-main); font-size:18px;">Command Deck</h2>
                        <span style="font-size:10px; color:var(--success);">LIVE FEED ACTIVE</span>
                    </div>
                    <button class="btn" style="padding:5px 10px; font-size:10px; border:1px solid #333; background:transparent;" onclick="document.getElementById('visuals-feed').innerHTML=''">CLEAR</button>
                </div>
                
                <input type="file" id="file-upload" style="display:none" onchange="handleFile(this)">
                <div class="upload-zone" onclick="document.getElementById('file-upload').click()">
                    <i data-lucide="upload-cloud" size="24" style="margin-bottom:10px; opacity:0.7;"></i>
                    <div style="font-weight:700; font-size:12px;">IMPORT DATASET</div>
                    <div style="font-size:10px; color:var(--text-muted);">CSV / LOGS</div>
                </div>

                <div id="visuals-feed" class="viz-feed">
                    <div style="text-align:center; color:#333; margin-top:20px; font-size:12px;">
                        Waiting for dataset to visualize...
                    </div>
                </div>
            </div>

            <div class="ai-right-panel">
                <div class="chat-header">
                    <div>
                        <span style="font-weight:700;">XYZ-GPT v14 (CEO Mode)</span>
                        <span style="font-size:10px; color:var(--primary); margin-left:8px;">● OMNISCIENT</span>
                    </div>
                </div>
                
                <div class="chat-history" id="chat-history">
                    <div class="msg ai">
                        <strong>System Ready.</strong><br>
                        I monitor all 5 departments: Computer, Cyber, Finance, Services, and Marketing. Upload threat data to cross-reference vulnerability.
                    </div>
                </div>

                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Query dataset (e.g. 'Impact on Finance dept')..." style="flex:1; background:#111; border:1px solid #333; color:white; padding:12px; border-radius:8px; outline:none;" onkeydown="if(event.key==='Enter') sendChat()">
                    <button class="btn" style="padding:0 20px;" onclick="sendChat()"><i data-lucide="send"></i></button>
                </div>
            </div>

        </div>
    </section>

    <section id="view-earth" class="view-section">
        <div id="earth-wrapper">
            <div class="btn-close" onclick="exitFullscreenEarth()"><i data-lucide="x"></i></div>
            <div class="hud-overlay">
                <div style="display:flex; justify-content:space-between;">
                    <div>
                        <div style="font-size:24px; font-weight:800; color:var(--primary)">HOLOGRAPHIC MODE</div>
                        <div style="font-family: monospace; color:var(--success)" id="hand-status">SYSTEM: WAITING FOR HAND...</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-family: monospace">CAM: ACTIVE</div>
                        <div style="font-family: monospace">FPS: 60</div>
                    </div>
                </div>
                <div class="hud-scanner"></div>
                <div style="display:flex; justify-content:center;">
                    <div class="scan-result" id="scan-popup">
                        <div style="font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">THREAT DETECTED</div>
                        <div style="font-size:24px; font-weight:800; color:white;" id="scan-title">TARGET</div>
                        <div style="font-size:14px; color:var(--danger); margin-top:5px;" id="scan-desc">Info</div>
                    </div>
                </div>
            </div>
            <div id="earth-container"></div>
        </div>
    </section>
    <section id="view-map" class="view-section">
    <div style="width:100%; height:100%; position:relative; overflow:hidden;">
        <div id="map-container"></div>
        
        <div class="map-hud-panel">
            <div style="font-size:14px; font-weight:800; color:white; margin-bottom:15px; border-bottom:2px solid var(--primary); padding-bottom:10px;">TACTICAL LAYERS</div>
            
            <div class="layer-toggle active" onclick="toggleLayer('assets', this)">
                <div class="toggle-label">COMPANY ASSETS</div>
                <div class="toggle-switch"></div>
            </div>
            
            <div class="layer-toggle active" onclick="toggleLayer('perimeter', this)">
                <div class="toggle-label">DIGITAL FENCE</div>
                <div class="toggle-switch"></div>
            </div>
            
            <div class="layer-toggle" onclick="toggleLayer('traffic', this)">
                <div class="toggle-label">NET TRAFFIC</div>
                <div class="toggle-switch"></div>
            </div>
        </div>
    </div>
</section>

    <!-- PASTE THIS AFTER <section id="view-earth"> -->
    <section id="view-live-earth" class="view-section">
        <div style="position: relative; width: 100%; height: 100%; background: black;">
            <!-- HUD -->
            <div style="position: absolute; top: 30px; left: 30px; z-index: 10; pointer-events: none;">
                <div style="color: var(--primary); font-size: 24px; font-weight: 800; letter-spacing: 2px;">LIVE SENSOR GRID</div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
                    <div style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 10px var(--primary); animation: blink 1s infinite;"></div>
                    <div style="font-family: monospace; color: var(--text-muted); font-size: 12px;" id="live-packet-count">TRACKING 0 EVENTS</div>
                </div>
                <div style="font-family: monospace; color: #555; font-size: 10px; margin-top: 5px;">MOUSE CONTROL: ENABLED</div>
            </div>

            <div class="btn-close" onclick="switchView('dashboard')" style="display:flex;"><i data-lucide="x"></i></div>
            
            <!-- The 3D Container -->
            <div id="live-earth-container" style="width: 100%; height: 100%;"></div>
        </div>
    </section>

    <style>
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>

    <div class="modal-overlay" id="command-modal">
    <div style="width:400px; background:#111; padding:30px; border-radius:12px; border:1px solid var(--danger);">
        <h3 style="color:var(--danger)">INCIDENT COMMAND PROMPT</h3>
        <p style="font-size:12px; color:#888;">Threat Detected: <strong id="modal-threat-type"></strong> from <strong id="modal-threat-origin"></strong></p>
        <p style="font-size:14px; margin-top:15px;" id="modal-threat-details"></p>

        <h4 style="margin-top:20px; color:var(--primary)">EMERGENCY DIRECTIVES</h4>
        <button class="btn btn-danger" style="margin-right:10px;" onclick="sendQuickCommand('Computer', 'Isolate Network Segment')">ISOLATE NETWORK</button>
        <button class="btn" onclick="sendQuickCommand('Cybersecurity', 'Elevate Firewall Level')">ELEVATE DEFCON</button>
        
        <button class="btn" style="background:transparent; border:1px solid #555; color:#888; margin-top:20px;" onclick="document.getElementById('command-modal').style.display='none'">DISMISS</button>
    </div>
</div>

</main>

<script>
lucide.createIcons();

/* ================= FACE LOCK JS (from onlyFace.html) ================= */
const lockStatus = document.getElementById("lock-status");  // <-- you were missing this

let lockStream = null;
let faceMatcher = null;
let mapInstance = null;
let mapLayers = { assets: null, perimeter: null, traffic: null };



window.addEventListener("load", async () => {
    const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";

    try {
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);

        initLockCamera();
    } catch (e) {
        lockStatus.innerText = "SECURITY MODULE FAILED";
        lockStatus.style.color = "#FF453A";
    }
});

// Start camera
async function initLockCamera() {
    try {
        lockStream = await navigator.mediaDevices.getUserMedia({ video: {} });
        const video = document.getElementById("lock-video");
        video.srcObject = lockStream;

        video.onloadedmetadata = () => {
            video.play();
            verifyAdmin();
        };
    } catch (err) {
        lockStatus.innerText = "CAMERA ERROR";
        lockStatus.style.color = "#FF453A";
    }
}

// Main scan loop
async function verifyAdmin() {
    const savedFace = localStorage.getItem("ceo_face_id");

    if (!savedFace) {
        lockStatus.innerText = "NO ADMIN FOUND. SETUP REQUIRED.";
        lockStatus.style.color = "#FF9F0A";
        return;
    }

    const descriptor = new Float32Array(Object.values(JSON.parse(savedFace)));
    const labeled = new faceapi.LabeledFaceDescriptors("CEO", [descriptor]);
    faceMatcher = new faceapi.FaceMatcher(labeled, 0.45);

    lockStatus.innerText = "SCANNING BIOMETRICS...";
    lockStatus.style.color = "#0A84FF";

    const video = document.getElementById("lock-video");

    const interval = setInterval(async () => {
        const det = await faceapi
            .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptor();

        if (det) {
            const match = faceMatcher.findBestMatch(det.descriptor);

            if (match.label === "CEO") {
                clearInterval(interval);
                unlockSystem();
            } else {
                lockStatus.innerText = "ACCESS DENIED: UNKNOWN FACE";
                lockStatus.style.color = "#FF453A";
            }
        }
    }, 500);
}

// Admin setup UI
function toggleSetup() {
    const s = document.getElementById("admin-setup");
    s.style.display = s.style.display === "block" ? "none" : "block";
}

function verifyPasscode() {
    const code = document.getElementById("passcode-input").value;

    if (code === "xyz-admin") {
        document.getElementById("enroll-btn").classList.remove("hidden");
        lockStatus.innerText = "ADMIN PROTOCOL UNLOCKED";
        lockStatus.style.color = "#30D158";
    } else {
        alert("INVALID PASSCODE");
    }
}

async function enrollFace() {
    lockStatus.innerText = "CAPTURING...";

    const video = document.getElementById("lock-video");

    const det = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

    if (det) {
        localStorage.setItem("ceo_face_id", JSON.stringify(det.descriptor));
        alert("FACE ID SAVED. RESTARTING.");
        location.reload();
    } else {
        alert("NO FACE DETECTED");
    }
}

// When verified → unlock
function unlockSystem() {
    lockStatus.innerText = "IDENTITY VERIFIED. WELCOME CEO.";
    lockStatus.style.color = "#30D158";

    setTimeout(() => {
        document.getElementById("lock-screen").style.transform = "translateY(-100%)";

        if (lockStream) lockStream.getTracks().forEach(t => t.stop());

        // App is already visible behind lock; no need app-container.
        // Just ensure Earth is ready.
        initEarth();

    }, 1500);
}

/* ========================================================================
   1. GLOBAL STATE & NAVIGATION
   ======================================================================== */
let OPENAI_KEY = localStorage.getItem('openai_key') || "";
let chatHistoryLog = [
    { role: "system", content: "You are XYZ Sentinel. You are a cybersecurity expert. Provide responses in Markdown. You are responsible for 5 departments: Computer, Cybersecurity, Finance, Services, Marketing." }
];
let GLOBAL_STATS = {}; 

let activeCameraStream = null;
let animationFrameId = null; 
let currentIncidentData = null;

function switchView(id) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    const nav = document.getElementById('nav-' + id);
    if(nav) nav.classList.add('active');

    // NEW: Initialize map if switching to map view
    if (id === 'map') {
        setTimeout(() => {
            if (!mapInstance) initTacticalMap();
            else mapInstance.invalidateSize(); // Fixes grey box issue
        }, 100);
    }
}


function saveKey() {
    const val = document.getElementById('api-input').value;
    if(val) { 
        localStorage.setItem('openai_key', val); 
        OPENAI_KEY = val; 
        alert("Key Saved"); 
        document.getElementById('api-modal').style.display='none'; 
    }
}

/* ========================================================================
   2. DEPARTMENTAL LOGIC
   ======================================================================== */

function sendCommand(dept, action) {
    alert(`[DIRECTIVE SENT]\nTo: ${dept} Department\nAction: ${action}\nStatus: PENDING ACKNOWLEDGEMENT`);
    
    // Map the human-readable name → card id
    const deptIdMap = {
        "Computer":      "dept-computer",
        "Cybersecurity": "dept-cyber",
        "Finance":       "dept-finance",
        "Services":      "dept-services",
        "Marketing":     "dept-marketing"
    };
    const deptId = deptIdMap[dept];
    if (deptId) {
        triggerDepartmentAlert(deptId);
    }

    switchView('ai');
    addMsg(`<strong>[CEO COMMAND LOG]</strong><br>Department: ${dept}<br>Directive: ${action}`, 'user');
    
    setTimeout(() => {
        const aiReply = `Directive received for **${dept}**. ${action} has been initiated. I will monitor the specific vulnerability channels associated with this department.`;
        addMsg(aiReply, 'ai');
    }, 1000);
}


function triggerDepartmentAlert(deptId) {
    const card = document.getElementById(deptId);
    if (!card) return;
    card.classList.add('alert');
    card.querySelector('.dept-status').innerText = "HIGH RISK DETECTED";
}

/* ========================================================================
   3. INTELLIGENCE ENGINE
   ======================================================================== */

function handleFile(input) {
    const file = input.files[0];
    if(!file) return;
    
    document.getElementById('visuals-feed').innerHTML = `<div style="text-align:center; color:var(--warning);">Scanning all columns in ${file.name}...</div>`;
    addMsg(`<strong>Dataset Uploaded:</strong> ${file.name}`, 'user');

    const reader = new FileReader();
    reader.onload = async (e) => {
        const text = e.target.result;
        GLOBAL_STATS = parseUniversalStats(text);
        
        const feed = document.getElementById('visuals-feed');
        feed.innerHTML = "";
        
        const keys = Object.keys(GLOBAL_STATS);
        const attackKey = keys.find(k => k.toLowerCase().includes('attack') || k.toLowerCase().includes('type'));
        const countryKey = keys.find(k => k.toLowerCase().includes('country') || k.toLowerCase().includes('geo'));
        
        if(attackKey) renderWidget(feed, attackKey.toUpperCase(), GLOBAL_STATS[attackKey]);
        if(countryKey) renderWidget(feed, countryKey.toUpperCase(), GLOBAL_STATS[countryKey]);

        await sendOmniscientTruthToAI(GLOBAL_STATS, text.substring(0, 5000));
    };
    reader.readAsText(file);
}

function parseUniversalStats(csvText) {
    const lines = csvText.split('\n').filter(line => line.trim() !== '');
    if(lines.length < 2) return {};
    const headers = lines[0].split(',').map(h => h.trim().replace(/['"]+/g, ''));
    const stats = {};
    headers.forEach(h => stats[h] = {});

    for (let i = 1; i < lines.length; i++) {
        const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g); 
        if (!row) continue;
        row.forEach((val, index) => {
            if(headers[index]) {
                let cleanVal = val.replace(/['"]+/g, '').trim();
                if(cleanVal) stats[headers[index]][cleanVal] = (stats[headers[index]][cleanVal] || 0) + 1;
            }
        });
    }
    return stats;
}

function renderWidget(container, title, dataObj) {
    const widget = document.createElement('div');
    widget.className = 'viz-widget';
    let content = `<div class="viz-header"><div class="viz-title">// ${title}</div><div class="viz-delete" onclick="this.closest('.viz-widget').remove()">[X]</div></div>`;
    const sorted = Object.entries(dataObj).sort((a,b) => b[1] - a[1]).slice(0, 5);
    let max = sorted[0] ? sorted[0][1] : 1;
    
    sorted.forEach(([label, value]) => {
        const pct = (value / max) * 100;
        const color = `hsl(${Math.random() * 360}, 70%, 60%)`;
        content += `<div class="bar-row"><div class="bar-label" title="${label}">${label}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%; background:${color}"></div></div><div class="bar-val" style="color:${color}">${value}</div></div>`;
    });
    widget.innerHTML = content;
    container.insertBefore(widget, container.firstChild);
}

async function sendOmniscientTruthToAI(stats, sampleText) {
    if(!OPENAI_KEY) return document.getElementById('api-modal').style.display='flex';
    let columnSummary = "";
    Object.keys(stats).forEach(col => {
        const top5 = Object.entries(stats[col]).sort((a,b)=>b[1]-a[1]).slice(0,5).map(e=>`${e[0]}(${e[1]})`).join(", ");
        columnSummary += `- Column "${col}": ${top5}\n`;
    });
    
    // --- MODIFIED PROMPT TO REQUIRE JSON/MARKDOWN MATRIX ---
    const prompt = `SYSTEM: I have parsed the CSV. HERE IS THE TRUTH:\n${columnSummary}\n
    TASK: Analyze the top 5 threats/categories. For each one, determine the most vulnerable department (Computer, Cyber, Finance, Services, Marketing), assign a Risk Score (1-10), and provide a concise Recommended Action.
    
    Respond ONLY with the Markdown table below, filling in the content based on the data provided:
    
    | Vulnerability Type | Affected Department | Risk Score (1-10) | Recommended Action |
    | :--- | :--- | :--- | :--- |
    | [Type 1] | [Department] | [Score] | [Action] |
    | [Type 2] | [Department] | [Score] | [Action] |
    | ... | ... | ... | ... |
    `;
    // -------------------------------------------------------

    await callAI(prompt);
}
/* ---------------------------------------------------------
   HANDLER: ONE-SHOT + CAMERA KILL
   --------------------------------------------------------- */
/* ---------------------------------------------------------
   HANDLER: ONE-SHOT + CAMERA KILL - MODIFIED FOR NEW MODAL
   --------------------------------------------------------- */
function handleDrillDownCommand(data) {
    // 1. Immediately kill the Hand Tracking camera and animation
    exitFullscreenEarth(); 

    // 2. Map the data object to the structure expected by the new modal
    const threatPacket = {
        origin: data.name.split('(')[0].trim(),
        target: "Global HQ", // Fixed for this map
        type: data.type,
        risk: "CRITICAL"
    };

    // 3. Display the interactive Command Modal
    showLiveCommandModal(threatPacket); 
    
    // The rest of the AI logic can now be handled via the modal's buttons (sendQuickCommand)
    // We can add a log entry to the chat history to confirm the incident.
    switchView('ai'); // Switch to AI view behind the modal
    addMsg(
        `<strong>[Hologram Command]</strong> Incident Command Prompt initiated for ${threatPacket.origin}.`,
        'user'
    );
}


async function sendChat() {
    const input = document.getElementById('chat-input');
    const text = input.value;
    if(!text) return;
    addMsg(text, 'user');
    input.value = "";
    const augmentedText = text + " (Context: You are advising the CEO of XYZ Company. Relate answers to the 5 departments: Computer, Cyber, Finance, Services, Marketing.)";
    await callAI(augmentedText, true); 
}

async function callAI(userText, isUserChat = false) {
    if(!OPENAI_KEY) return;
    chatHistoryLog.push({role:"user", content: userText}); 
    try {
        const res = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {"Content-Type":"application/json", "Authorization":`Bearer ${OPENAI_KEY}`},
            body: JSON.stringify({ model: "gpt-4o-mini", messages: chatHistoryLog })
        });
        const data = await res.json();
        const content = data.choices[0].message.content;
        chatHistoryLog.push({role:"assistant", content: content});
        processAIResponse(content);
    } catch(e) { addMsg("Error: " + e.message, 'ai'); }
}

function processAIResponse(content) {
    const jsonMatch = content.match(/```json([\s\S]*?)```/);
    let visData = null;
    let cleanText = content;
    if(jsonMatch) {
        try {
            visData = JSON.parse(jsonMatch[1]);
            cleanText = content.replace(jsonMatch[0], ""); 
        } catch(e) {}
    }
    if(cleanText.trim()) addMsg(cleanText, 'ai');
    if(visData && visData.data) {
        const feed = document.getElementById('visuals-feed');
        const mappedData = {};
        visData.data.forEach(d => mappedData[d.label] = d.value);
        renderWidget(feed, visData.title || "ANALYSIS", mappedData);
    }
}

function addMsg(text, type) {
    const d = document.createElement('div');
    d.className = `msg ${type}`;
    d.innerHTML = marked.parse(text);
    document.getElementById('chat-history').appendChild(d);
    document.getElementById('chat-history').scrollTop = 99999;
}

/* ========================================================================
   4. HOLOGRAM MODE (STABLE + WARMUP DELAY)
   ======================================================================== */

const videoElement = document.querySelector('.input_video');
const debugCanvas = document.getElementById('debug-canvas');
const debugCtx = debugCanvas ? debugCanvas.getContext('2d') : null;
const handStatus = document.getElementById('hand-status');

let isTracking = false;
let targetRotY = 0.002, targetRotX = 0; 
let friction = 1.0; 
let commandHasFired = false;
let interactionReady = false;

// Earth globals (original pattern)
const earthScene = new THREE.Scene();
const earthCamera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
earthCamera.position.z = 2.5;

const earthRenderer = new THREE.WebGLRenderer({alpha: true, antialias: true});
const earthContainer = document.getElementById('earth-container');
if (earthContainer) {
    earthRenderer.setSize(earthContainer.offsetWidth, earthContainer.offsetHeight);
    earthContainer.appendChild(earthRenderer.domElement);
}
const earthGroup = new THREE.Group();
earthScene.add(earthGroup);


// Called after face unlock; just ensures sizing is OK
function initEarth() {
    if (earthContainer) {
        earthRenderer.setSize(earthContainer.offsetWidth, earthContainer.offsetHeight);
        earthCamera.aspect = earthContainer.offsetWidth / earthContainer.offsetHeight;
        earthCamera.updateProjectionMatrix();
    }
}

// Wireframe
const matWire = new THREE.MeshBasicMaterial({color: 0x333333, wireframe: true, transparent: true, opacity: 0.3});
earthGroup.add(new THREE.Mesh(new THREE.SphereGeometry(1, 48, 48), matWire));

// Particles
const pGeo = new THREE.BufferGeometry();
const pPos = [];
for(let i=0; i<1500; i++) {
    const r = 1.02, theta = Math.random()*Math.PI*2, phi = Math.acos(2*Math.random()-1);
    pPos.push(r*Math.sin(phi)*Math.cos(theta), r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi));
}
pGeo.setAttribute('position', new THREE.Float32BufferAttribute(pPos, 3));
earthGroup.add(new THREE.Points(pGeo, new THREE.PointsMaterial({color: 0x0A84FF, size: 0.015})));

// CEO Features
function createArc(start, end) {
    const mid = start.clone().add(end).multiplyScalar(0.5).normalize().multiplyScalar(1.5);
    const curve = new THREE.QuadraticBezierCurve3(start, mid, end);
    const points = curve.getPoints(20);
    const geometry = new THREE.BufferGeometry().setFromPoints(points);
    const material = new THREE.LineBasicMaterial({ color: 0x30D158, opacity: 0.5, transparent: true });
    return new THREE.Line(geometry, material);
}

function latLonToVec(lat, lon, r) {
    const phi = (90-lat)*(Math.PI/180);
    const theta = (lon+180)*(Math.PI/180);
    return new THREE.Vector3(-(r*Math.sin(phi)*Math.cos(theta)), r*Math.cos(phi), r*Math.sin(phi)*Math.sin(theta));
}

// MAP THREATS TO DEPARTMENTS
const threats = [
    {name:"CHINA (Botnet)", lat:35.86, lon:104.19, info:"RISK: DDoS -> Computer Dept", type:"DDoS"}, 
    {name:"RUSSIA (Ransomware)", lat:61.52, lon:105.31, info:"RISK: Encryption -> Finance", type:"Ransomware"}, 
    {name:"USA (Phishing)", lat:37.09, lon:-95.71, info:"RISK: Social Eng -> Marketing", type:"Phishing"}
];
const hqPos = latLonToVec(3.13, 101.68, 1.0); 
const markerMeshes = [];
threats.forEach(t => {
    const pos = latLonToVec(t.lat, t.lon, 1.05);
    const m = new THREE.Mesh(new THREE.OctahedronGeometry(0.05), new THREE.MeshBasicMaterial({color:0xFF453A, wireframe:true}));
    m.position.copy(pos); m.userData = t;
    earthGroup.add(m); markerMeshes.push(m);
    earthGroup.add(createArc(pos, hqPos));
});
const hqMesh = new THREE.Mesh(new THREE.OctahedronGeometry(0.03), new THREE.MeshBasicMaterial({color:0x30D158}));
hqMesh.position.copy(hqPos); earthGroup.add(hqMesh);

// Hand Logic
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

let isDrillingDown = false;

hands.onResults((results) => {
    if(!isTracking) return;
    debugCtx.clearRect(0, 0, 320, 240);
    debugCtx.drawImage(results.image, 0, 0, 320, 240);

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        drawConnectors(debugCtx, results.multiHandLandmarks[0], HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
        handStatus.innerText = "HAND DETECTED - SYSTEM LINKED"; handStatus.style.color = "#30D158";

        const lm = results.multiHandLandmarks[0];
        const indexTip = lm[8]; const thumbTip = lm[4]; 
        const pinchDistance = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);
        
        const CLICK_THRESHOLD = 0.04; 
        const ROTATE_THRESHOLD = 0.20;

        const isClicking = pinchDistance < CLICK_THRESHOLD; 
        const isOpenHandRotate = pinchDistance > ROTATE_THRESHOLD;
        
        isDrillingDown = false; 

        if (isClicking) {
            if(interactionReady) {
                handStatus.innerText = "COMMAND: CLICK CONFIRMED";
                handStatus.style.color = "#FF453A";
                isDrillingDown = true; 
                targetRotY = 0; targetRotX = 0;
            } else {
                handStatus.innerText = "SYSTEM BOOTING...";
                handStatus.style.color = "#FF9F0A";
            }
        } else if (isOpenHandRotate) {
            handStatus.innerText = "MANUAL ROTATE (Open Hand)";
            targetRotY = (indexTip.x - 0.5) * 0.06;
            targetRotX = (indexTip.y - 0.5) * 0.06;
        } else {
            handStatus.innerText = "HAND DETECTED (Idle)";
            targetRotY = 0; targetRotX = 0;
        }
    } else {
        handStatus.innerText = "WAITING FOR HAND..."; handStatus.style.color = "#FF9F0A";
        targetRotY = 0.002; targetRotX = 0; isDrillingDown = false;
    }
});

async function forceStartCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } });
        activeCameraStream = stream; 
        videoElement.srcObject = stream;
        videoElement.onloadeddata = () => {
            videoElement.play();
            isTracking = true;
            processVideoFrame();
        };
    } catch (err) { alert("Camera Error: " + err.name); }
}

async function processVideoFrame() {
    if (!isTracking) return;
    if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
        await hands.send({image: videoElement});
    }
    animationFrameId = requestAnimationFrame(processVideoFrame);
}

const scanPopup = document.getElementById('scan-popup');
const vec = new THREE.Vector3();

function animate() {
    if (!isTracking) return;

    requestAnimationFrame(animate);
    earthGroup.rotation.y += targetRotY * friction;
    earthGroup.rotation.x += targetRotX * friction;

    let found = false;
    markerMeshes.forEach(m => {
        m.getWorldPosition(vec);
        if(vec.z > 0.9 && Math.abs(vec.x) < 0.25 && Math.abs(vec.y) < 0.25) {
            found = true; 
            m.scale.set(2.0, 2.0, 2.0); m.material.color.setHex(0xFFFFFF);
            scanPopup.style.opacity = 1; scanPopup.style.transform = 'translateY(0)';
            document.getElementById('scan-title').innerText = m.userData.name;
            document.getElementById('scan-desc').innerText = m.userData.info;
            friction = 0.15; 

            if (isDrillingDown && !commandHasFired && interactionReady) {
                commandHasFired = true; 
                handleDrillDownCommand(m.userData);
            }

        } else { 
            m.scale.set(1,1,1); m.material.color.setHex(0xFF453A); 
        }
    });

    if(!found) { 
        scanPopup.style.opacity = 0; 
        scanPopup.style.transform = 'translateY(20px)'; 
        friction = 1.0; 
    }
    earthRenderer.render(earthScene, earthCamera);
}

window.enterFullscreenEarth = function() {
    switchView('earth');
    document.getElementById('earth-wrapper').classList.add('fullscreen');
    document.getElementById('debug-canvas').style.opacity = 1;
    
    commandHasFired = false;
    isTracking = true;
    interactionReady = false; 

    setTimeout(() => { interactionReady = true; }, 1500);

    forceStartCamera();
    
    setTimeout(() => {
        earthRenderer.setSize(window.innerWidth, window.innerHeight);
        earthCamera.aspect = window.innerWidth / window.innerHeight;
        earthCamera.updateProjectionMatrix();
        animate();
    }, 100);
}

    window.exitFullscreenEarth = function() {
        // 1. Remove Fullscreen Styling
        document.getElementById('earth-wrapper').classList.remove('fullscreen');
        document.getElementById('debug-canvas').style.opacity = 0;
        
        // 2. Stop Tracking Logic
        isTracking = false; 
        if(animationFrameId) cancelAnimationFrame(animationFrameId);

        // 3. Kill Camera (Hardware)
        if(activeCameraStream) {
            activeCameraStream.getTracks().forEach(track => track.stop());
            activeCameraStream = null;
        }
        videoElement.pause();
        videoElement.srcObject = null; 

        // 4. NAVIGATE BACK TO DASHBOARD (The missing link)
        switchView('dashboard'); 

        // 5. Reset Renderer size for the small view (optional cleanup)
        setTimeout(() => {
            const c = document.getElementById('earth-container');
            if(c) {
                earthRenderer.setSize(c.offsetWidth, c.offsetHeight);
                earthCamera.aspect = c.offsetWidth / c.offsetHeight;
                earthCamera.updateProjectionMatrix();
            }
        }, 100);
    }


/* ========================================================================
   5. LIVE DATA ENGINE (Vanilla JS Port)
   ======================================================================== */
const LIVE_PACKETS = [];
const MAX_PACKETS = 50;
const ATTACK_TYPES = ['DDoS', 'Injection', 'Malware', 'Phishing', 'Traffic'];
const COUNTRIES = ['USA', 'CHN', 'RUS', 'DEU', 'BRA', 'JPN', 'FRA'];

// 1. Start the Data Stream
function initDataStream() {
    console.log("Connecting to Global Sensor Grid...");
    
    // Use Wikipedia Recent Changes as a proxy for "Traffic"
    const eventSource = new EventSource('https://stream.wikimedia.org/v2/stream/recentchange');
    
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'edit') {
            const packet = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('en-US', {hour12:false}),
                origin: COUNTRIES[Math.floor(Math.random() * COUNTRIES.length)],
                source: data.user,
                target: data.title.substring(0, 20),
                type: ATTACK_TYPES[Math.floor(Math.random() * ATTACK_TYPES.length)],
                risk: Math.random() > 0.95 ? 'CRITICAL' : (Math.random() > 0.8 ? 'HIGH' : 'LOW')
            };

            // Add to buffer
            LIVE_PACKETS.unshift(packet);
            if(LIVE_PACKETS.length > MAX_PACKETS) LIVE_PACKETS.pop();

            // Update UI
            updateLiveTable();
            updateLiveEarthMarkers();
        }
    };
    
    // Synthetic Fallback (Keep it looking busy)
    setInterval(() => {
        if(Math.random() > 0.5) return; // Only sometimes
        const packet = {
            id: Date.now(),
            time: new Date().toLocaleTimeString('en-US', {hour12:false}),
            origin: COUNTRIES[Math.floor(Math.random() * COUNTRIES.length)],
            source: "192.168.0." + Math.floor(Math.random()*255),
            target: "Internal-Server-" + Math.floor(Math.random()*10),
            type: "Traffic",
            risk: "LOW"
        };
        LIVE_PACKETS.unshift(packet);
        if(LIVE_PACKETS.length > MAX_PACKETS) LIVE_PACKETS.pop();
        updateLiveTable();
        updateLiveEarthMarkers();
    }, 1000);
}

// 2. Dashboard Table Render
function updateLiveTable() {
    const tbody = document.getElementById('live-feed-body');
    if(!tbody) return;
    
    // Only render top 15 to save DOM performance
    const rows = LIVE_PACKETS.slice(0, 15).map(p => {
        let color = '#30D158'; // Green
        if(p.risk === 'HIGH') color = '#FF9F0A'; // Orange
        if(p.risk === 'CRITICAL') color = '#FF453A'; // Red

        return `
            <tr style="border-bottom: 1px solid #222; color: #ccc;">
                <td style="padding: 8px; color: #666;">${p.time}</td>
                <td style="padding: 8px;"><span style="color:#555">[${p.origin}]</span> ${p.source}</td>
                <td style="padding: 8px;">${p.target}</td>
                <td style="padding: 8px; color: var(--primary);">${p.type}</td>
                <td style="padding: 8px; text-align: right; color: ${color}; font-weight: bold;">${p.risk}</td>
            </tr>
        `;
    }).join('');
    
    tbody.innerHTML = rows;
}

// Start data immediately
initDataStream();


/* ========================================================================
   6. LIVE EARTH (REALISTIC + MOUSE CONTROL)
   ======================================================================== */
let liveScene, liveCamera, liveRenderer, liveControls, liveEarthGroup;
let liveMarkers = [];
let raycaster = new THREE.Raycaster();
let mouse = new THREE.Vector2();
let INTERSECTED = null; // To store the currently highlighted object
let threatPopup = null; // Reference to the 3D pop-up mesh


function initLiveEarth() {
    switchView('live-earth');
    
    const container = document.getElementById('live-earth-container');
    if(liveRenderer) return; // Already initialized

    // Scene Setup
    liveScene = new THREE.Scene();
    // Add stars
    const starGeo = new THREE.BufferGeometry();
    const starPos = [];
    for(let i=0; i<3000; i++) {
        starPos.push((Math.random()-0.5)*200, (Math.random()-0.5)*200, (Math.random()-0.5)*200);
    }
    starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
    const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.1}));
    liveScene.add(stars);

    // Camera
    liveCamera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    liveCamera.position.z = 3.5;

    // Renderer
    liveRenderer = new THREE.WebGLRenderer({ antialias: true });
    liveRenderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(liveRenderer.domElement);
    
    // --- ADD INTERACTION LISTENERS ---
    container.addEventListener('mousemove', onLiveMapMouseMove, false);
    container.addEventListener('click', onLiveMapClick, false);
    // ---------------------------------


    // Controls
    liveControls = new THREE.OrbitControls(liveCamera, liveRenderer.domElement);
    liveControls.enablePan = false;
    liveControls.enableZoom = true;
    liveControls.minDistance = 1.5;
    liveControls.maxDistance = 5;
    liveControls.autoRotate = true;
    liveControls.autoRotateSpeed = 0.8;

    // Earth Group
    liveEarthGroup = new THREE.Group();
    liveScene.add(liveEarthGroup);

    // Realistic Texture
    const texLoader = new THREE.TextureLoader();
    texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg', (tex) => {
        const sphere = new THREE.Mesh(
            new THREE.SphereGeometry(1, 64, 64),
            new THREE.MeshBasicMaterial({ map: tex }) // Use Basic for simplicity/performance
        );
        liveEarthGroup.add(sphere);
    });

    // Atmosphere Glow
    const atmos = new THREE.Mesh(
        new THREE.SphereGeometry(1.02, 64, 64),
        new THREE.MeshBasicMaterial({ color: 0x0A84FF, transparent: true, opacity: 0.1, side: THREE.BackSide })
    );
    liveEarthGroup.add(atmos);

    // Animation Loop
    animateLiveEarth();
}

function animateLiveEarth() {
    requestAnimationFrame(animateLiveEarth);
    liveControls.update();

    // --- RAYCASTING LOGIC FOR INTERACTION ---
    if (liveRenderer) {
        raycaster.setFromCamera(mouse, liveCamera);
        
        // Only check against visible, interactable markers
        const intersects = raycaster.intersectObjects(liveMarkers); 

        if (intersects.length > 0) {
            const hit = intersects[0].object;

            if (INTERSECTED !== hit) {
                // Restore old marker color
                if (INTERSECTED) INTERSECTED.material.color.setHex(0xFF453A); 
                
                INTERSECTED = hit;
                // Highlight new marker (e.g., white)
                INTERSECTED.material.color.setHex(0xFFFFFF); 
            }
        } else {
            // Restore old marker color when mouse moves off
            if (INTERSECTED) INTERSECTED.material.color.setHex(0xFF453A); 
            INTERSECTED = null;
        }
    }
    // ----------------------------------------

    liveRenderer.render(liveScene, liveCamera);
}

// Convert Live Data into 3D Markers on the realistic globe
function updateLiveEarthMarkers() {
    if(!liveEarthGroup) return;

    // Clear old markers
    liveMarkers.forEach(m => liveEarthGroup.remove(m));
    liveMarkers = [];
    
    document.getElementById('live-packet-count').innerText = `TRACKING ${LIVE_PACKETS.length} EVENTS`;

    // Add new markers based on PACKETS
    LIVE_PACKETS.forEach(p => {
        // Generate pseudo-random Lat/Lon based on packet ID hash
        const hash = p.id;
        const lat = (Math.sin(hash) * 80); // -80 to 80
        const lon = (Math.cos(hash) * 180); // -180 to 180

        // Convert to Vector3
        const phi = (90 - lat) * (Math.PI / 180);
        const theta = (lon + 180) * (Math.PI / 180);
        const r = 1.02;
        
        const x = -(r * Math.sin(phi) * Math.cos(theta));
        const z = r * Math.sin(phi) * Math.sin(theta);
        const y = r * Math.cos(phi);

        // Create Spike
        const height = p.risk === 'CRITICAL' ? 0.3 : 0.1;
        const color = p.risk === 'CRITICAL' ? 0xFF453A : 0x30D158;
        
        const geo = new THREE.CylinderGeometry(0.005, 0.005, height, 8);
        geo.translate(0, height/2, 0); // Pivot at base
        geo.rotateX(Math.PI / 2); // Orient correctly
        
        const mat = new THREE.MeshBasicMaterial({ color: color });
        const mesh = new THREE.Mesh(geo, mat);
        
        mesh.position.set(x, y, z);
        mesh.lookAt(0, 0, 0); // Point outwards

        // --- ADD USER DATA HERE ---
        mesh.userData = {
            threatData: p, // Store the full packet data
            isThreat: true,
        };
        // --------------------------
        
        liveEarthGroup.add(mesh);
        liveMarkers.push(mesh);
    });
}

// Handle Window Resize for Live Earth
window.addEventListener('resize', () => {
    if(liveRenderer && document.getElementById('view-live-earth').classList.contains('active')) {
        liveCamera.aspect = window.innerWidth / window.innerHeight;
        liveCamera.updateProjectionMatrix();
        liveRenderer.setSize(window.innerWidth, window.innerHeight);
    }
});

// Function to update mouse coordinates (normalized)
function onLiveMapMouseMove(event) {
    const rect = liveRenderer.domElement.getBoundingClientRect();
    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
}

// Function to handle marker clicks
function onLiveMapClick(event) {
    if (INTERSECTED) {
        // Assume INTERSECTED marker has a userData object with threat info
        const threatData = INTERSECTED.userData.threatData;
        if (threatData) {
            // Call a new function to open the command modal
            showLiveCommandModal(threatData); 
        }
    }
}

function showLiveCommandModal(threat) {
    // --- Store incident data for later use in sendQuickCommand ---
    currentIncidentData = threat;
    // -------------------------------------------------------------
    
    document.getElementById('modal-threat-type').innerText = threat.type;
    document.getElementById('modal-threat-origin').innerText = threat.origin;
    document.getElementById('modal-threat-details').innerHTML = 
        `**Risk Level:** <span style="color: var(--danger);">${threat.risk || 'CRITICAL'}</span><br>` +
        `**Target:** ${threat.target}<br>` +
        `**Source User/IP:** ${threat.source || 'N/A'}`; // Added || 'N/A' for Hologram data

    document.getElementById('command-modal').style.display = 'flex';
}

function sendQuickCommand(dept, action) {
    // 1. Send the CEO Directive (Alert)
    sendCommand(dept, action); 
    document.getElementById('command-modal').style.display = 'none';

    // 2. --- CRITICAL: Initiate AI Threat Analysis ---
    if (currentIncidentData) {
        const threat = currentIncidentData;
        const query = `CEO COMMAND: Detailed threat assessment for the ${threat.origin} incident (${threat.type}). We have initiated the **${action}** protocol for the ${dept} department. Provide a comprehensive summary of the predicted impact and next 3 steps.`;
        
        // Switch to AI view (already done by sendCommand, but ensures context)
        switchView('ai'); 

        // Call AI core with the detailed query
        callAI(query, true); 
        
        // Clear the data after use
        currentIncidentData = null;
    }
}

/* ========================================================================
   7. REAL-TIME CHART ENGINE (Chart.js)
   ======================================================================== */

let throughputChart = null;
const MAX_DATA_POINTS = 20; // Show last 20 seconds of data

const liveValueEl = document.getElementById('live-throughput-value');
const statusIndicatorEl = document.getElementById('throughput-status-indicator');

// 1. Initialize the Chart
function initRealtimeChart() {
    const ctx = document.getElementById('realtimeChart').getContext('2d');
    
    // Gradient fill for a modern, sci-fi look
    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
    gradient.addColorStop(0, 'rgba(10, 132, 255, 0.5)'); // var(--primary)
    gradient.addColorStop(1, 'rgba(10, 132, 255, 0)');

    throughputChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(MAX_DATA_POINTS).fill(''), // Initialize empty labels
            datasets: [{
                label: 'Throughput (p/s)',
                data: Array(MAX_DATA_POINTS).fill(0), // Initialize data with zeros
                borderColor: 'var(--primary)',
                backgroundColor: gradient,
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.4, // Smooth curve
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    display: true,
                    title: { display: false },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: 'var(--text-muted)' }
                },
                y: {
                    display: true,
                    min: 0,
                    max: 30, // Adjust this max value based on expected traffic peaks
                    title: { display: true, text: 'Packets/sec', color: 'var(--text-muted)' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: 'var(--text-muted)' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        }
    });
}

// 2. Update the Chart with new data
// 2. Update the Chart with new data and analyze status
function updateRealtimeChart(newValue) {
    if (!throughputChart) return;
    
    const time = new Date().toLocaleTimeString('en-US', { second: '2-digit' });

    // --- Dynamic Status Analysis ---
    let statusColor = 'var(--success)'; // Default: Green
    let statusMessage = 'Status: OPTIMAL FLOW';
    
    // Thresholds:
    if (newValue > 20) {
        statusColor = 'var(--warning)'; // Orange
        statusMessage = 'Status: ELEVATED TRAFFIC WARNING';
    }
    if (newValue > 25) {
        statusColor = 'var(--danger)'; // Red
        statusMessage = 'Status: CRITICAL THRESHOLD BREACH';
    }

    // Update HTML Status Indicators
    if (liveValueEl && statusIndicatorEl) {
        liveValueEl.innerText = newValue.toFixed(1); // Display the value with one decimal place
        liveValueEl.style.color = statusColor;
        statusIndicatorEl.innerText = statusMessage;
        statusIndicatorEl.style.color = statusColor;
    }
    // -------------------------------

    // Remove the oldest point
    throughputChart.data.labels.shift();
    throughputChart.data.datasets[0].data.shift();

    // Add the new point
    throughputChart.data.labels.push(time);
    throughputChart.data.datasets[0].data.push(newValue);

    throughputChart.update('quiet'); // 'quiet' prevents animation for smooth real-time update
}


// Global counter for traffic simulation
let currentPacketCount = 0;

// 3. Connect to the Live Data Stream (using the synthetic stream)
// 3. Connect to the Live Data Stream (using the enhanced synthetic stream)
function connectChartToDataStream() {
    // This interval will simulate the flow of data
    setInterval(() => {
        // Generate a synthetic value: Normal flow (10-20) + chance for spike (up to 35)
        let baseValue = 15; // Normal flow average
        let fluctuation = (Math.random() - 0.5) * 5; // Fluctuation of +/- 2.5
        let spike = Math.random() < 0.15 ? Math.random() * 20 : 0; // 15% chance of a large spike
        
        let packetsPerSecond = baseValue + fluctuation + spike;
        packetsPerSecond = Math.max(0, packetsPerSecond); // Ensure no negative values
        
        // Push the new value to the chart and status indicators
        updateRealtimeChart(packetsPerSecond);
    }, 1000); // Update every 1 second
}

// 4. Start everything when the system unlocks
window.addEventListener('load', () => {
    // Only initialize the chart AFTER all other components are loaded
    setTimeout(() => {
        initRealtimeChart();
        connectChartToDataStream();
    }, 2500); // Wait a moment after the page loads
});

// ==========================================
// FIX 1: MISSING HELPER FUNCTIONS
// ==========================================

// 1. Helper to create the cool HTML popups for the Map
function createHexPopup(title, status, cpu, temp) {
    const color = status === 'ONLINE' ? '#30D158' : '#FF453A';
    return `
        <div style="min-width:150px;">
            <div style="border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:5px; font-weight:bold; color:${color}">
                ${title}
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; color:#aaa;">
                <span>STATUS:</span> <span style="color:${color}; text-align:right">${status}</span>
                <span>CPU:</span> <span style="text-align:right; color:white">${cpu}</span>
                <span>TEMP:</span> <span style="text-align:right; color:white">${temp}</span>
            </div>
        </div>
    `;
}

// 2. Helper to start the scrolling terminal on the map
function startMapTerminal() {
    const term = document.getElementById('map-terminal');
    if(!term) return; // Safety check
    
    // Clear initial text
    term.innerHTML = '';
    
    const verbs = ["SCANNING", "PINGING", "TRACING", "ENCRYPTING", "PACKET LOSS"];
    const locs = ["192.168.0.1", "PROXY_GATE_4", "FIREWALL_N", "SAT_UPLINK"];
    
    setInterval(() => {
        const v = verbs[Math.floor(Math.random() * verbs.length)];
        const l = locs[Math.floor(Math.random() * locs.length)];
        const time = new Date().toLocaleTimeString().split(' ')[0];
        
        const line = `<div style="margin-bottom:2px;">[${time}] ${v} > ${l}...</div>`;
        
        term.innerHTML += line;
        term.scrollTop = term.scrollHeight; // Auto scroll to bottom
        
        // Keep it clean (remove old lines)
        if(term.children.length > 15) term.removeChild(term.firstChild);
        
    }, 800); 
}

function initTacticalMap() {
    // 1. Create Map (Centered on Taylor's University)
    mapInstance = L.map('map-container', { zoomControl: false }).setView([3.063158, 101.616896], 14);

    // 2. Add Dark Mode Tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 19
    }).addTo(mapInstance);

    // 3. Define Icon Styles
    const iconAsset = L.divIcon({ className: 'custom-div-icon', html: "<div class='blip secure'></div>", iconSize: [20, 20] });
    
    // --- 4. CREATE LAYERS ---

    // A. ASSETS LAYER (The Icons)
    const hq = L.marker([3.063158, 101.616896], {icon: iconAsset})
        .bindPopup(createHexPopup("HQ MAINFRAME", "ONLINE", "12%", "34°C"));
        
    const serverFarm = L.marker([3.059158, 101.615801], {icon: iconAsset})
        .bindPopup(createHexPopup("SERVER NODE A", "ONLINE", "87%", "65°C"));
        
    const satLink = L.marker([3.083482, 101.616905], {icon: iconAsset})
        .bindPopup(createHexPopup("SAT LINK 4", "ONLINE", "25%", "43°C"));

    // * IMPORTANT: Add them to the layer group AND the map *
    mapLayers.assets = L.layerGroup([hq, serverFarm, satLink]).addTo(mapInstance);


    // B. PERIMETER LAYER (The Circles)
    const geoFence = L.circle([3.063158, 101.616896], {
        color: '#30D158',       // Green
        fillColor: '#30D158',
        fillOpacity: 0.1,
        radius: 1500            // <--- YOU MISSED THIS (Size of circle)
    });

    const weakZone = L.circle([3.085033, 101.550521], {
        color: '#FF9F0A',       // Orange
        fillColor: '#FF9F0A',
        fillOpacity: 0.2,
        radius: 800             // <--- YOU MISSED THIS
    }).bindPopup("WARNING: FIREWALL THIN");

    // * IMPORTANT: Add to layer group and map *
    mapLayers.perimeter = L.layerGroup([geoFence, weakZone]).addTo(mapInstance);


    // C. TRAFFIC LAYER (The Lines)
    const line1 = L.polyline([[3.063158, 101.616896], [3.059158, 101.615801]], {color: '#0A84FF', weight: 2, className: 'traffic-line-anim'});
    const line2 = L.polyline([[3.063158, 101.616896], [3.083482, 101.616905]], {color: '#0A84FF', weight: 2, className: 'traffic-line-anim'});
    const attackLine = L.polyline([[3.083395, 101.585108], [3.085033, 101.550521]], {color: '#FF453A', weight: 3, className: 'traffic-line-anim'});

    // Traffic is usually OFF by default to keep map clean, so we DON'T .addTo(mapInstance) here
    // The toggle button will handle adding it.
    mapLayers.traffic = L.layerGroup([line1, line2, attackLine]);

    // 5. Start the Scrolling Text
    startMapTerminal();
}

function toggleLayer(layerName, btnElement) {
    if (!mapInstance) return;

    const layer = mapLayers[layerName];
    const isNowActive = btnElement.classList.toggle('active');

    if (isNowActive) {
        mapInstance.addLayer(layer);
    } else {
        mapInstance.removeLayer(layer);
    }
}

// =========================================================================
// 6. LIVE CYBER-INTELLIGENCE SENSORS
// =========================================================================

// Global storage for the AI to read later
let latestCVE = "None";
let latestNews = "None";

// Initialize sensors when page loads
document.addEventListener('DOMContentLoaded', () => {
    initSensors();
});

function initSensors() {
    fetchLatestCVE();
    fetchSecurityNews();
    startNetworkSimulation();
    
    // Refresh API data every 60 seconds
    setInterval(() => {
        fetchLatestCVE();
        fetchSecurityNews();
    }, 60000);
}

// API 1: LATEST CVE (Vulnerability Database)
async function fetchLatestCVE() {
    try {
        const res = await fetch('https://cve.circl.lu/api/last');
        const data = await res.json();
        
        const item = data[0]; // Get the newest one
        latestCVE = item.id;
        const summary = item.summary.length > 60 ? item.summary.substring(0, 60) + "..." : item.summary;

        document.getElementById('api-cve').innerText = latestCVE;
        document.getElementById('api-cve').style.color = 'var(--danger)'; 
        document.getElementById('api-cve-desc').innerText = summary;
    } catch(e) {
        // Fallback if API fails
        document.getElementById('api-cve').innerText = "CVE-2025-ERR";
        document.getElementById('api-cve-desc').innerText = "Simulated: Buffer Overflow detected...";
        latestCVE = "CVE-2025-ERR (Simulated)";
    }
}

// API 2: HACKER NEWS (Security Filter)
async function fetchSecurityNews() {
    try {
        const resIds = await fetch('https://hacker-news.firebaseio.com/v0/newstories.json');
        const ids = await resIds.json();
        
        let foundStory = null;
        // Scan top 20 stories for security keywords
        for (let i = 0; i < 20; i++) {
            const resItem = await fetch(`https://hacker-news.firebaseio.com/v0/item/${ids[i]}.json`);
            const item = await resItem.json();
            const text = (item.title || "").toLowerCase();
            
            if(text.includes('security') || text.includes('hack') || text.includes('breach') || text.includes('malware') || text.includes('vulnerability')) {
                foundStory = item;
                break;
            }
        }
        
        if (!foundStory) {
             // Fallback: just get the top story
             const resItem = await fetch(`https://hacker-news.firebaseio.com/v0/item/${ids[0]}.json`);
             foundStory = await resItem.json();
        }

        latestNews = foundStory.title;
        document.getElementById('api-news').innerText = latestNews.length > 50 ? latestNews.substring(0,50)+"..." : latestNews;
        document.getElementById('api-news-src').innerText = "SOURCE: HACKER_NEWS / " + new Date().toLocaleTimeString();

    } catch(e) {
        document.getElementById('api-news').innerText = "CONNECTING TO SECURE FEED...";
    }
}

// AI REPORT GENERATOR
function generateLiveReport() {
    // Check if key exists
    if(!OPENAI_KEY) {
        document.getElementById('api-modal').style.display = 'flex';
        return;
    }

    switchView('ai'); // Jump to Chat Tab
    
    const prompt = `
    SYSTEM ALERT:
    1. Latest Global Vulnerability: ${latestCVE}
    2. Latest Security News: "${latestNews}"
    
    TASK: 
    Act as the CISO. Briefly explain what risk this CVE or News headline poses to our company (XYZ Sentinel). 
    If the news is generic, provide general security advice for the Computer and Cybersecurity departments.
    `;

    addMsg(`<strong>[AUTOMATED SENSOR REPORT]</strong><br>Analyzing Live Feeds...`, 'user');
    callAI(prompt, true);
}

// NETWORK SIMULATION (Visual Only)
function startNetworkSimulation() {
    const canvas = document.getElementById('network-canvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    let dataPoints = new Array(50).fill(10);
    
    function draw() {
        const newVal = Math.random() * 30 + 10;
        dataPoints.push(newVal); dataPoints.shift();
        
        const packets = Math.floor(newVal * 12);
        const el = document.getElementById('net-packets');
        if(el) el.innerText = packets;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.strokeStyle = '#0A84FF'; ctx.lineWidth = 2;
        
        const width = canvas.width; const height = canvas.height; const step = width / dataPoints.length;
        ctx.moveTo(0, height);
        dataPoints.forEach((val, i) => { ctx.lineTo(i * step, height - val); });
        ctx.stroke();
        requestAnimationFrame(draw);
    }
    canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
    draw();
}

</script>

</body>
</html>
